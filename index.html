<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1">

<link rel="stylesheet" href="./resources/ol.css">
<link rel="stylesheet" href="./resources/fontawesome-all.min.css">
<link rel="stylesheet" href="./resources/photon-geocoder-autocomplete.min.css">
<link rel="stylesheet" href="./resources/ol-layerswitcher.css">
<link rel="stylesheet" href="./resources/qgis2web.css">

<style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}
#map {
    width: 100vw;
    height: 100vh;
}
#logos {
    position: absolute;
    bottom: 15px;
    right: 15px;
    display: flex;
    gap: 12px;
    z-index: 2000;
    pointer-events: none;
}
#logos img {
    height: 42px;
    background: rgba(255,255,255,0.9);
    padding: 6px 8px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
</style>

<title>ASADAS AyA WebGIS</title>
</head>

<body>

<div id="map">

<div id="logos">
    <img src="resources/Aliarse_Logo.png">
    <img src="resources/Geolux_logo.png">
</div>

<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
</div>

</div>

<!-- Core -->
<script src="./resources/qgis2web_expressions.js"></script>
<script src="./resources/functions.js"></script>
<script src="./resources/ol.js"></script>
<script src="./resources/ol-layerswitcher.js"></script>
<script src="./resources/photon-geocoder-autocomplete.min.js"></script>

<!-- Layers -->
<script src="./layers/AsadasAyA_2.js"></script>
<script src="./layers/ASADASVisita_3.js"></script>
<script src="./layers/Costa_Rica_ADM1_simplifiedsimplified_4.js"></script>

<!-- Styles -->
<script src="./styles/AsadasAyA_2_style.js"></script>
<script src="./styles/ASADASVisita_3_style.js"></script>
<script src="./styles/Costa_Rica_ADM1_simplifiedsimplified_4_style.js"></script>

<script src="./layers/layers.js"></script>
<script src="./resources/Autolinker.min.js"></script>
<script src="./resources/qgis2web.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function () {

    // Wait until qgis2web finishes creating the map
    setTimeout(function() {

        if (typeof map === "undefined") {
            console.error("Map not available.");
            return;
        }

        console.log("Map ready.");

        /* ==========================
           SAFE Layer Switcher
        ========================== */
        if (!map.getControls().getArray().some(c => c instanceof ol.control.LayerSwitcher)) {
            var layerSwitcher = new ol.control.LayerSwitcher({
                activationMode: 'click',
                startActive: false
            });
            map.addControl(layerSwitcher);
        }

        /* ==========================
           Load Route Safely
        ========================== */
        fetch('./layers/optimized_route.geojson')   // IMPORTANT: local relative path
            .then(response => response.json())
            .then(data => {

                var routeSource = new ol.source.Vector({
                    features: new ol.format.GeoJSON().readFeatures(data, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: map.getView().getProjection()
                    })
                });

                var routeLayer = new ol.layer.Vector({
                    source: routeSource,
                    title: "Optimized Route",
                    visible: true,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: "#cc0000",
                            width: 2
                        })
                    })
                });

                map.addLayer(routeLayer);

                map.getView().fit(routeSource.getExtent(), {
                    padding: [50,50,50,50]
                });

                console.log("Route loaded.");

            })
            .catch(error => console.error("Route error:", error));

    }, 800); // Give qgis2web time to finish

});

</script>
    
</body>
</html>
